<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVA Incident Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .form-input {
            width: 100%; padding: 0.75rem 1rem; border-radius: 0.5rem;
            border: 1px solid #cbd5e1; background-color: #ffffff; transition: all 0.2s;
        }
        .form-input:focus { outline: none; border-color: #b91c1c; box-shadow: 0 0 0 3px rgba(185, 28, 28, 0.1); }
        .tab-btn { padding: 0.75rem 1.5rem; font-weight: 600; color: #64748b; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn.active { color: #b91c1c; border-bottom: 2px solid #b91c1c; }
        .student-list { max-height: 180px; overflow-y: auto; background: #fff; border: 1px solid #cbd5e1; padding: 0.5rem; border-radius: 0.5rem; }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <div id="view-login" class="fixed inset-0 z-50 bg-slate-100 flex items-center justify-center p-4 sm:p-8">
        <div class="bg-white flex flex-col md:flex-row w-full max-w-4xl rounded-2xl shadow-xl overflow-hidden border border-slate-200 fade-in">
            <div class="w-full md:w-1/2 bg-red-800 p-10 text-white flex flex-col justify-center relative">
                <div class="relative z-10">
                    <h2 class="text-3xl font-bold mb-4">SVA Incident Portal</h2>
                    <p class="text-red-100 mb-6 leading-relaxed">Secure reporting and tracking for student incidents, behavior, and interventions.</p>
                </div>
            </div>
            <div class="w-full md:w-1/2 p-10 flex flex-col justify-center items-center text-center">
                <h1 class="text-2xl font-bold text-slate-800 mb-2">Secure Sign In</h1>
                <p class="text-slate-500 mb-8 text-sm">Use your official <strong>@svaschool.org</strong> account.</p>
                <div id="g_id_onload" data-client_id="14216824305-v19ecsmrhk1muaglrlhjceqjk5oeqr4n.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_select="false"></div>
                <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular"></div>
            </div>
        </div>
    </div>

    <div id="view-app" class="hidden min-h-screen max-w-5xl mx-auto p-4 sm:p-8">
        <header class="mb-6 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-slate-100">
                <div>
                    <h1 class="text-lg font-bold text-red-800">SVA Incident Portal</h1>
                    <p class="text-xs text-slate-500"><span id="user-display"></span> | Role: <span id="role-display" class="font-bold capitalize"></span></p>
                </div>
                <button onclick="logout()" class="text-sm text-slate-500 hover:text-slate-800 transition">Sign Out</button>
            </div>
            <div class="flex px-2 pt-2 bg-slate-50">
                <button onclick="switchTab('dashboard')" id="tab-btn-dashboard" class="tab-btn active">Student Dashboard</button>
                <button onclick="switchTab('report')" id="tab-btn-report" class="tab-btn">File New Report</button>
            </div>
        </header>

        <div id="tab-dashboard" class="fade-in">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6">
                <input type="text" id="filter-search" placeholder="Search students by name..." class="form-input text-sm" oninput="renderDashboard()">
            </div>
            <div id="dashboard-feed" class="space-y-4 pb-10">
                <div class="text-center py-10 text-slate-500">Loading student records...</div>
            </div>
        </div>

        <div id="tab-report" class="hidden fade-in">
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6 sm:p-8">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">File Incident Report</h2>
                <form id="submission-form" onsubmit="submitReport(event)" class="space-y-5">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">Incident Date</label>
                            <input type="date" id="incDate" required class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Incident Type</label>
                            <select id="incType" required class="form-input">
                                <option value="" disabled selected>Select...</option>
                                <option value="Injury">Medical / Injury</option>
                                <option value="Physical Altercation">Physical Altercation / Fight</option>
                                <option value="Bullying">Bullying / Harassment</option>
                                <option value="Verbal Abuse">Verbal Abuse / Disrespect</option>
                                <option value="Property Damage">Property Damage</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">Location</label>
                            <input type="text" id="incLocation" required placeholder="e.g., Cafeteria" class="form-input">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                        <div class="border border-slate-200 p-4 rounded-lg bg-slate-50">
                            <label class="block text-sm font-bold text-slate-700 mb-2">Primary Student(s) Involved</label>
                            <input type="text" id="search-primary" placeholder="Search primary students..." class="form-input text-sm mb-2" oninput="filterCheckboxes(this, 'primary-students-list')">
                            <div id="primary-students-list" class="student-list space-y-2 text-sm"></div>
                        </div>
                        <div class="border border-slate-200 p-4 rounded-lg bg-slate-50">
                            <label class="block text-sm font-bold text-slate-700 mb-2">Witness / Related Student(s)</label>
                            <input type="text" id="search-related" placeholder="Search related students..." class="form-input text-sm mb-2" oninput="filterCheckboxes(this, 'related-students-list')">
                            <div id="related-students-list" class="student-list space-y-2 text-sm"></div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-1">Detailed Description</label>
                        <textarea id="incDescription" required rows="4" placeholder="What happened before, during, and after?" class="form-input"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-1">Immediate Action Taken</label>
                        <textarea id="incAction" required rows="2" placeholder="e.g., Sent to nurse, separated students..." class="form-input"></textarea>
                    </div>

                    <div class="pt-4">
                        <button type="submit" id="submit-btn" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-3 rounded-lg transition">Submit Report</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxJgMn6ad4FbQsK31Ue5TQhG3f-kcL16yX_FeHz-N-sE1cLrro8O92TfNsNQJ4VwfL6Xw/exec"; 
    let USER_TOKEN = "", USER_EMAIL = "", USER_ROLE = "";
    let STUDENTS = [], REPORTS = [];

    function handleCredentialResponse(response) {
        USER_TOKEN = response.credential; 
        USER_EMAIL = JSON.parse(atob(response.credential.split('.')[1])).email;
        document.getElementById('view-login').classList.add('hidden');
        document.getElementById('view-app').classList.remove('hidden');
        document.getElementById('user-display').innerText = USER_EMAIL;
        fetchData();
    }

    function logout() {
        USER_TOKEN = ""; USER_EMAIL = "";
        document.getElementById('view-app').classList.add('hidden');
        document.getElementById('view-login').classList.remove('hidden');
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-btn-${tabName}`).classList.add('active');
        document.getElementById('tab-dashboard').classList.add('hidden');
        document.getElementById('tab-report').classList.add('hidden');
        document.getElementById(`tab-${tabName}`).classList.remove('hidden');
    }

    function fetchData() {
        fetch(BACKEND_URL, {
            method: 'POST', body: JSON.stringify({ action: 'init', token: USER_TOKEN })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                USER_ROLE = data.role; STUDENTS = data.students; REPORTS = data.reports;
                document.getElementById('role-display').innerText = USER_ROLE;
                populateStudents(); 
                renderDashboard();
            } else { alert(data.message); logout(); }
        });
    }

    function populateStudents() {
        let html = '';
        STUDENTS.forEach(s => {
            html += `<label class="flex items-center space-x-2 py-1"><input type="checkbox" value="${s.name} (${s.id})" class="form-checkbox text-red-600 rounded"><span>${s.name} - ${s.grade}</span></label>`;
        });
        document.getElementById('primary-students-list').innerHTML = html || "No assigned students found.";
        document.getElementById('related-students-list').innerHTML = html || "No assigned students found.";
    }

    function filterCheckboxes(inputElement, listId) {
        const filter = inputElement.value.toLowerCase();
        const labels = document.getElementById(listId).getElementsByTagName('label');
        for (let i = 0; i < labels.length; i++) {
            const text = labels[i].innerText.toLowerCase();
            labels[i].style.display = text.includes(filter) ? "flex" : "none";
        }
    }

    // ==========================================
    // NEW DASHBOARD RENDER LOGIC
    // ==========================================
    function renderDashboard() {
        const query = document.getElementById('filter-search').value.toLowerCase();
        const feed = document.getElementById('dashboard-feed');
        
        const filteredStudents = STUDENTS.filter(s => s.name.toLowerCase().includes(query));

        if (filteredStudents.length === 0) {
            feed.innerHTML = `<div class="text-slate-500 text-center py-10 bg-white rounded-xl border border-slate-200">No students found.</div>`;
            return;
        }

        let html = '';
        filteredStudents.forEach(s => {
            const studentString = `${s.name} (${s.id})`;
            
            // Find all reports involving this student (Primary or Related)
            const studentReports = REPORTS.filter(r => r.primary.includes(studentString) || r.related.includes(studentString));
            
            // Count incidents by type
            const counts = {};
            studentReports.forEach(r => counts[r.type] = (counts[r.type] || 0) + 1);

            // Generate badges based on counts
            let badges = '';
            if (Object.keys(counts).length === 0) {
                badges = `<span class="bg-slate-100 text-slate-500 text-xs font-semibold px-2 py-1 rounded-md">0 Incidents</span>`;
            } else {
                for (const [type, count] of Object.entries(counts)) {
                    badges += `<span class="bg-red-50 border border-red-200 text-red-700 text-xs font-semibold px-2 py-1 rounded-md mr-2">${type}: ${count}</span>`;
                }
            }

            // Generate the list of reports for the expanded view
            let reportsHTML = '';
            if (studentReports.length > 0) {
                reportsHTML = `<div class="mt-4 space-y-2">`;
                studentReports.forEach(r => {
                    let statusColor = r.status === 'Pending Review' ? 'text-yellow-600' : 'text-green-600';
                    reportsHTML += `
                        <div class="bg-white p-3 rounded border border-slate-200 flex justify-between items-center">
                            <div>
                                <p class="text-sm font-bold text-slate-800">${r.type} <span class="text-slate-400 font-normal">#${r.id}</span></p>
                                <p class="text-xs text-slate-500">${r.date} &bull; <span class="font-medium ${statusColor}">${r.status}</span></p>
                            </div>
                            <button onclick="downloadFormalPDF('${r.id}')" class="text-blue-600 hover:text-blue-800 text-xs font-semibold underline">Download PDF</button>
                        </div>
                    `;
                });
                reportsHTML += `</div>`;
            } else {
                reportsHTML = `<p class="text-sm text-slate-500 italic mt-3">No incident history for this student.</p>`;
            }

            // Build Accordion Card
            html += `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden fade-in">
                    <div class="p-4 cursor-pointer hover:bg-slate-50 transition flex justify-between items-center" onclick="toggleDetails('${s.id}')">
                        <div>
                            <h3 class="text-lg font-bold text-slate-800">${s.name} <span class="text-slate-400 text-sm font-normal ml-1">Grade ${s.grade}</span></h3>
                            <div class="mt-2 flex flex-wrap gap-2">${badges}</div>
                        </div>
                        <div class="text-slate-400">
                            <svg id="icon-${s.id}" class="w-6 h-6 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    
                    <div id="details-${s.id}" class="hidden bg-slate-50 p-4 border-t border-slate-200">
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold text-slate-700 text-sm">Incident History</h4>
                            <button onclick="fileReportForStudent('${studentString}')" class="bg-red-700 text-white text-xs font-bold px-4 py-2 rounded shadow hover:bg-red-800 transition">
                                + File New Report for Student
                            </button>
                        </div>
                        ${reportsHTML}
                    </div>
                </div>
            `;
        });
        feed.innerHTML = html;
    }

    function toggleDetails(studentId) {
        const details = document.getElementById(`details-${studentId}`);
        const icon = document.getElementById(`icon-${studentId}`);
        if (details.classList.contains('hidden')) {
            details.classList.remove('hidden');
            icon.classList.add('rotate-180');
        } else {
            details.classList.add('hidden');
            icon.classList.remove('rotate-180');
        }
    }

    function fileReportForStudent(studentString) {
        switchTab('report');
        
        // Reset Form
        document.getElementById('submission-form').reset();
        
        // Clear searches and reset lists
        document.getElementById('search-primary').value = '';
        document.getElementById('search-related').value = '';
        filterCheckboxes(document.getElementById('search-primary'), 'primary-students-list');
        filterCheckboxes(document.getElementById('search-related'), 'related-students-list');

        // Uncheck all boxes
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        
        // Check only the specific student in the primary list
        const targetCb = document.querySelector(`#primary-students-list input[value="${studentString}"]`);
        if (targetCb) {
            targetCb.checked = true;
            targetCb.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        window.scrollTo(0, 0);
    }

    function getSelectedCheckboxes(containerId) {
        return Array.from(document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`)).map(cb => cb.value);
    }

    function submitReport(e) {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        const primary = getSelectedCheckboxes('primary-students-list');
        const related = getSelectedCheckboxes('related-students-list');

        if(primary.length === 0) return alert("Please select at least one primary student.");

        btn.disabled = true; btn.innerText = "Submitting...";

        fetch(BACKEND_URL, {
            method: 'POST', mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'submitReport', token: USER_TOKEN,
                incidentDate: document.getElementById('incDate').value, incidentType: document.getElementById('incType').value,
                location: document.getElementById('incLocation').value, primaryStudents: primary, relatedStudents: related,
                description: document.getElementById('incDescription').value, actionTaken: document.getElementById('incAction').value
            })
        }).then(() => {
            alert("Report submitted successfully.");
            document.getElementById('submission-form').reset();
            fetchData(); switchTab('dashboard');
            btn.disabled = false; btn.innerText = "Submit Report";
        });
    }

    // Official PDF Generator
    function downloadFormalPDF(reportId) {
        const r = REPORTS.find(rep => rep.id === reportId);
        if (!r) return;

        const printDiv = document.createElement('div');
        printDiv.style.position = 'absolute'; printDiv.style.left = '-9999px'; printDiv.style.top = '0';
        printDiv.innerHTML = `
            <div style="width: 800px; padding: 50px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; color: #1e293b; background: #fff;">
                <div style="text-align: center; border-bottom: 3px solid #b91c1c; padding-bottom: 20px; margin-bottom: 30px;">
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; color: #7f1d1d; letter-spacing: 1px;">SVA SCHOOL</h1>
                    <h2 style="font-size: 16px; margin: 8px 0 0 0; color: #64748b; text-transform: uppercase; letter-spacing: 2px;">Official Incident Report</h2>
                </div>
                
                <table style="width: 100%; font-size: 14px; margin-bottom: 25px; border-collapse: collapse;">
                    <tr><td style="padding: 8px 0;"><strong>Report ID:</strong> ${r.id}</td><td style="padding: 8px 0; text-align: right;"><strong>Status:</strong> ${r.status}</td></tr>
                    <tr><td style="padding: 8px 0;"><strong>Date of Incident:</strong> ${r.date}</td><td style="padding: 8px 0; text-align: right;"><strong>Date Filed:</strong> ${new Date(r.timestamp).toLocaleDateString()}</td></tr>
                    <tr><td style="padding: 8px 0;"><strong>Incident Type:</strong> ${r.type}</td><td style="padding: 8px 0; text-align: right;"><strong>Location:</strong> ${r.location}</td></tr>
                </table>

                <div style="background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 25px; border-radius: 4px;">
                    <p style="margin: 0 0 10px 0; font-size: 14px;"><strong>Reporting Staff / Faculty:</strong> ${r.reportedBy}</p>
                    <p style="margin: 0 0 10px 0; font-size: 14px;"><strong>Primary Student(s) Involved:</strong><br> <span style="color: #475569;">${r.primary}</span></p>
                    <p style="margin: 0; font-size: 14px;"><strong>Witness / Related Student(s):</strong><br> <span style="color: #475569;">${r.related || 'None reported'}</span></p>
                </div>

                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 16px; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; color: #0f172a;">Detailed Description</h3>
                    <p style="font-size: 14px; line-height: 1.6; color: #334155; white-space: pre-wrap;">${r.description}</p>
                </div>

                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 16px; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; color: #0f172a;">Immediate Action Taken</h3>
                    <p style="font-size: 14px; line-height: 1.6; color: #334155; white-space: pre-wrap;">${r.actionTaken}</p>
                </div>

                ${r.comments ? `<div style="margin-bottom: 25px;"><h3 style="font-size: 16px; border-bottom: 2px solid #b91c1c; padding-bottom: 5px; color: #7f1d1d;">Administrative Review Notes</h3><p style="font-size: 14px; line-height: 1.6; color: #334155; white-space: pre-wrap;">${r.comments}</p></div>` : ''}

                <div style="margin-top: 80px; display: flex; justify-content: space-between;">
                    <div style="width: 40%; border-top: 1px solid #000; text-align: center; padding-top: 8px; font-size: 14px; font-weight: 600;">Staff Signature</div>
                    <div style="width: 40%; border-top: 1px solid #000; text-align: center; padding-top: 8px; font-size: 14px; font-weight: 600;">Administrator Signature</div>
                </div>
                
                <div style="margin-top: 40px; text-align: center; font-size: 10px; color: #94a3b8;">
                    CONFIDENTIAL - SVA School Internal Records - Generated on ${new Date().toLocaleString()}
                </div>
            </div>
        `;
        document.body.appendChild(printDiv);

        const opt = {
            margin: 0, filename: `SVA_Incident_${reportId}.pdf`, image: { type: 'jpeg', quality: 1 },
            html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(printDiv.children[0]).save().then(() => { document.body.removeChild(printDiv); });
    }
</script>
</body>
</html>
