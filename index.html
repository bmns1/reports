<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVA Incident Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .form-input {
            width: 100%; padding: 0.75rem 1rem; border-radius: 0.5rem;
            border: 1px solid #cbd5e1; background-color: #ffffff; transition: all 0.2s;
        }
        .form-input:focus { outline: none; border-color: #0d9488; box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1); }
        .tab-btn { padding: 0.75rem 1.5rem; font-weight: 600; color: #64748b; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn.active { color: #0d9488; border-bottom: 2px solid #0d9488; }
        .student-list { max-height: 180px; overflow-y: auto; background: #fff; border: 1px solid #cbd5e1; padding: 0.5rem; border-radius: 0.5rem; }
    </style>
</head>
<body class="text-slate-800 antialiased relative">

    <div id="view-login" class="fixed inset-0 z-50 bg-slate-100 flex items-center justify-center p-4 sm:p-8">
        <div class="bg-white flex flex-col md:flex-row w-full max-w-4xl rounded-2xl shadow-xl overflow-hidden border border-slate-200 fade-in">
            <div class="w-full md:w-1/2 bg-teal-800 p-10 text-white flex flex-col justify-center relative">
                <div class="relative z-10">
                    <h2 class="text-3xl font-bold mb-4">SVA Incident Portal</h2>
                    <p class="text-teal-100 mb-6 leading-relaxed">Secure reporting, tracking, and intervention management for SVA Faculty & Administration.</p>
                </div>
            </div>
            <div class="w-full md:w-1/2 p-10 flex flex-col justify-center items-center text-center">
                <h1 class="text-2xl font-bold text-slate-800 mb-2">Secure Sign In</h1>
                <p class="text-slate-500 mb-8 text-sm">Use your official <strong>@svaschool.org</strong> account.</p>
                <div id="g_id_onload" data-client_id="14216824305-v19ecsmrhk1muaglrlhjceqjk5oeqr4n.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_select="false"></div>
                <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular"></div>
            </div>
        </div>
    </div>

    <div id="privacy-modal" class="hidden fixed inset-0 z-[70] bg-slate-900/95 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-3xl rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-red-700 p-6 text-white">
                <h2 class="text-2xl font-bold flex items-center">
                    <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    Critical Privacy & Compliance
                </h2>
                <p class="text-red-100 text-sm mt-1">Zero-Tolerance Policy & Amanah (Sacred Trust)</p>
            </div>
            <div class="p-8 overflow-y-auto text-slate-700 text-sm leading-relaxed space-y-6">
                <p class="font-bold">This portal contains sensitive student data protected by federal law and our religious obligation. Strict adherence to the following is mandatory:</p>
                
                <div class="space-y-4">
                    <div class="bg-red-50 p-4 rounded border-l-4 border-red-600">
                        <strong class="block text-red-800 text-base mb-1">1. Need-to-Know Access Only</strong>
                        <p><strong>Rule:</strong> Do not access records for students you are not actively supporting.</p>
                        <p class="text-slate-500 mt-1"><strong>Reason:</strong> Gossip destroys trust. Just because you can search for a student does not mean you should.</p>
                    </div>

                    <div class="bg-slate-50 p-4 rounded border-l-4 border-slate-400">
                        <strong class="block text-slate-800 text-base mb-1">2. "Screen Shield" Protocol</strong>
                        <p><strong>Rule:</strong> NEVER open this portal when a parent or student is present.</p>
                        <p class="text-slate-500 mt-1"><strong>Best Practice:</strong> Lock your screen (Win+L / Cmd+Ctrl+Q) before inviting anyone to your desk.</p>
                    </div>

                    <div class="bg-slate-50 p-4 rounded border-l-4 border-slate-400">
                        <strong class="block text-slate-800 text-base mb-1">3. Authorization for Parent Discussions</strong>
                        <p><strong>Rule:</strong> NEVER discuss internal notes/logs with a parent without prior approval from Admin.</p>
                        <p class="text-slate-500 mt-1"><strong>Reason:</strong> Notes may contain info about witness students that parents are legally not allowed to know.</p>
                    </div>

                    <div class="bg-slate-50 p-4 rounded border-l-4 border-slate-400">
                        <strong class="block text-slate-800 text-base mb-1">4. No "Raw" Data Transfer</strong>
                        <p><strong>Rule:</strong> Never screenshot dashboard or forward internal PDFs.</p>
                        <p class="text-slate-500 mt-1"><strong>Method:</strong> Only use the "Edit Parent PDF" feature to generate approved documents.</p>
                    </div>

                    <div class="bg-slate-50 p-4 rounded border-l-4 border-slate-400">
                        <strong class="block text-slate-800 text-base mb-1">5. Device Hygiene</strong>
                        <p><strong>Rule:</strong> Never leave your logged-in device unattended. Always Sign Out.</p>
                    </div>
                </div>

                <p class="text-xs text-center text-slate-400 border-t pt-4">Violation of these policies is a breach of contract and a betrayal of the trust parents place in us.</p>
            </div>
            <div class="p-4 bg-slate-100 border-t border-slate-200 text-right">
                <button onclick="acceptPrivacyPolicy()" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-8 rounded shadow transition">
                    I Acknowledge & Agree
                </button>
            </div>
        </div>
    </div>

    <div id="warning-modal" class="hidden fixed inset-0 z-[80] bg-red-900/40 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-xl shadow-2xl border-t-4 border-red-600 overflow-hidden animate-bounce-once">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">Privacy Reminder</h3>
                <p class="text-sm text-slate-600 mb-4 leading-relaxed">
                    You have accessed multiple student records in this session. Please remember the <strong>Need-to-Know</strong> policy.
                </p>
                <button onclick="document.getElementById('warning-modal').classList.add('hidden')" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-2 rounded shadow transition">
                    I Understand
                </button>
            </div>
        </div>
    </div>

    <div id="view-app" class="hidden min-h-screen max-w-5xl mx-auto p-4 sm:p-8">
        <header class="mb-6 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-slate-100">
                <div>
                    <h1 class="text-xl font-bold text-teal-800">SVA Incident Portal</h1>
                    <p class="text-xs text-slate-500"><span id="user-display"></span> &bull; Role: <span id="role-display" class="font-bold capitalize text-slate-700"></span></p>
                </div>
                <button onclick="logout()" class="text-sm font-semibold text-slate-500 hover:text-slate-800 transition">Sign Out</button>
            </div>
            <div class="flex px-2 pt-2 bg-slate-50">
                <button onclick="switchTab('dashboard')" id="tab-btn-dashboard" class="tab-btn active">Student Dashboard</button>
                <button onclick="switchTab('report')" id="tab-btn-report" class="tab-btn">File New Report</button>
            </div>
        </header>

        <div id="tab-dashboard" class="fade-in">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6 flex flex-col md:flex-row gap-4">
                <input type="text" id="filter-search" placeholder="Search students by name..." class="form-input text-sm md:w-2/3" oninput="renderDashboard()">
                <select id="filter-type" class="form-input text-sm md:w-1/3 font-semibold text-slate-700" onchange="renderDashboard()">
                    <option value="all">View All Students</option>
                    <option value="any_report">Only Students w/ Reports</option>
                    <option disabled>â”€â”€ Filter by Report Type â”€â”€</option>
                    <option value="Injury">Medical / Injury</option>
                    <option value="Physical Altercation">Physical Altercation</option>
                    <option value="Bullying">Bullying / Harassment</option>
                    <option value="Verbal Abuse">Verbal Abuse / Disrespect</option>
                    <option value="Property Damage">Property Damage</option>
                    <option value="Classroom Disruption">Classroom Disruption</option>
                    <option value="Technology Misuse">Technology Misuse</option>
                    <option value="Rude Parent">Rude/Angery Parent</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div id="dashboard-feed" class="space-y-4 pb-10">
                <div class="text-center py-10 text-slate-500">Loading student records...</div>
            </div>
        </div>

        <div id="tab-report" class="hidden fade-in">
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6 sm:p-8">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">File Incident Report</h2>
                <form id="submission-form" onsubmit="submitReport(event)" class="space-y-5">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1 text-slate-700">Incident Date</label>
                            <input type="date" id="incDate" required class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1 text-slate-700">Incident Type</label>
                            <select id="incType" required class="form-input text-red-700 font-semibold">
                                <option value="" disabled selected>Select...</option>
                                <option value="Injury">Medical / Injury</option>
                                <option value="Physical Altercation">Physical Altercation / Fight</option>
                                <option value="Bullying">Bullying / Harassment</option>
                                <option value="Verbal Abuse">Verbal Abuse / Disrespect</option>
                                <option value="Property Damage">Property Damage</option>
                                <option value="Classroom Disruption">Classroom Disruption</option>
                                <option value="Technology Misuse">Technology Misuse</option>
                                <option value="Rude Parent">Rude/Angery Parent</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1 text-slate-700">Location</label>
                            <input type="text" id="incLocation" required placeholder="e.g., Cafeteria, Playground" class="form-input">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                        <div class="border border-slate-200 p-4 rounded-xl bg-slate-50">
                            <label class="block text-sm font-bold text-slate-800 mb-2">Primary Student(s) Involved</label>
                            <input type="text" id="search-primary" placeholder="Search primary students..." class="form-input text-sm mb-3" oninput="filterCheckboxes(this, 'primary-students-list')">
                            <div id="primary-students-list" class="student-list space-y-2 text-sm"></div>
                        </div>
                        <div class="border border-slate-200 p-4 rounded-xl bg-slate-50">
                            <label class="block text-sm font-bold text-slate-800 mb-2">Witness / Related Student(s)</label>
                            <input type="text" id="search-related" placeholder="Search related students..." class="form-input text-sm mb-3" oninput="filterCheckboxes(this, 'related-students-list')">
                            <div id="related-students-list" class="student-list space-y-2 text-sm"></div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-1 text-slate-700">Detailed Description</label>
                        <textarea id="incDescription" required rows="4" placeholder="Objectively detail what happened before, during, and after..." class="form-input"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-1 text-slate-700">Student's Initial Response</label>
                        <textarea id="incStudentResponse" rows="2" placeholder="Detail what the student said or did immediately following the incident..." class="form-input"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-1 text-slate-700">Immediate Action Taken</label>
                        <textarea id="incAction" required rows="2" placeholder="e.g., Escorted to office, applied ice, separated parties..." class="form-input"></textarea>
                    </div>

                    <div class="pt-4">
                        <button type="submit" id="submit-btn" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-3 rounded-lg shadow-md transition transform active:scale-[0.99]">Submit Official Report</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="pdf-edit-modal" class="hidden fixed inset-0 z-[60] bg-slate-900/80 flex items-center justify-center p-4">
        <div class="bg-slate-200 w-full max-w-4xl max-h-[95vh] flex flex-col rounded-xl overflow-hidden shadow-2xl">
            <div class="bg-white p-4 border-b border-slate-300 flex justify-between items-center shadow-sm z-10">
                <div>
                    <h3 class="font-bold text-slate-800 text-lg">Edit Parent Report</h3>
                    <p class="text-xs text-slate-500">Click anywhere on the document below to redact or rewrite text before saving.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeEditablePDF()" class="px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100 rounded transition">Cancel</button>
                    <button onclick="saveEditedPDF()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 text-sm font-bold rounded shadow transition flex items-center gap-2">
                        Download PDF
                    </button>
                </div>
            </div>
            <div class="p-8 overflow-y-auto flex justify-center">
                <div id="editable-pdf-content" contenteditable="true" class="bg-white p-12 shadow-md w-[750px] min-h-[1000px] focus:outline-blue-400">
                    </div>
            </div>
        </div>
    </div>

<script>
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxJgMn6ad4FbQsK31Ue5TQhG3f-kcL16yX_FeHz-N-sE1cLrro8O92TfNsNQJ4VwfL6Xw/exec"; 
    let USER_TOKEN = "", USER_EMAIL = "", USER_ROLE = "";
    let STUDENTS = [], MY_STUDENTS = [], REPORTS = [];
    let ACTIVITY_TIMER;
    let VIEWED_STUDENTS = new Set(); 

    function handleCredentialResponse(response) {
        USER_TOKEN = response.credential; 
        USER_EMAIL = JSON.parse(atob(response.credential.split('.')[1])).email;
        document.getElementById('view-login').classList.add('hidden');
        document.getElementById('privacy-modal').classList.remove('hidden');
    }

    function acceptPrivacyPolicy() {
        document.getElementById('privacy-modal').classList.add('hidden');
        document.getElementById('view-app').classList.remove('hidden');
        document.getElementById('user-display').innerText = USER_EMAIL;
        fetchData();
        startActivityTimer();
    }

    function logout() {
        USER_TOKEN = ""; USER_EMAIL = "";
        VIEWED_STUDENTS.clear(); 
        document.getElementById('view-app').classList.add('hidden');
        document.getElementById('view-login').classList.remove('hidden');
        document.getElementById('privacy-modal').classList.add('hidden');
        clearTimeout(ACTIVITY_TIMER);
    }

    function startActivityTimer() {
        resetTimer();
        window.onmousemove = resetTimer;
        window.onkeypress = resetTimer;
        window.onclick = resetTimer;
        window.onscroll = resetTimer;
    }

    function resetTimer() {
        clearTimeout(ACTIVITY_TIMER);
        ACTIVITY_TIMER = setTimeout(() => {
            alert("Session expired due to inactivity. You have been logged out for security.");
            logout();
        }, 600000); 
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-btn-${tabName}`).classList.add('active');
        document.getElementById('tab-dashboard').classList.add('hidden');
        document.getElementById('tab-report').classList.add('hidden');
        document.getElementById(`tab-${tabName}`).classList.remove('hidden');
    }

    function fetchData() {
        fetch(BACKEND_URL, {
            method: 'POST', body: JSON.stringify({ action: 'init', token: USER_TOKEN })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                USER_ROLE = data.role; 
                STUDENTS = data.students; 
                MY_STUDENTS = data.myStudents || []; 
                REPORTS = data.reports;
                document.getElementById('role-display').innerText = USER_ROLE;
                populateStudents(); 
                renderDashboard();
            } else { alert(data.message); logout(); }
        });
    }

    function populateStudents() {
        let primaryHTML = '';
        let relatedHTML = '';
        STUDENTS.forEach(s => {
            primaryHTML += `<label class="flex items-center space-x-2 py-1"><input type="checkbox" id="primary-cb-${s.id}" value="${s.name} (${s.id})" class="form-checkbox text-red-600 rounded focus:ring-red-500"><span>${s.name} <span class="text-slate-400 ml-1 text-xs">Gr.${s.grade}</span></span></label>`;
            relatedHTML += `<label class="flex items-center space-x-2 py-1"><input type="checkbox" id="related-cb-${s.id}" value="${s.name} (${s.id})" class="form-checkbox text-red-600 rounded focus:ring-red-500"><span>${s.name} <span class="text-slate-400 ml-1 text-xs">Gr.${s.grade}</span></span></label>`;
        });
        document.getElementById('primary-students-list').innerHTML = primaryHTML || "No assigned students found.";
        document.getElementById('related-students-list').innerHTML = relatedHTML || "No assigned students found.";
    }

    function filterCheckboxes(inputElement, listId) {
        const filter = inputElement.value.toLowerCase();
        const labels = document.getElementById(listId).getElementsByTagName('label');
        for (let i = 0; i < labels.length; i++) {
            const text = labels[i].innerText.toLowerCase();
            labels[i].style.display = text.includes(filter) ? "flex" : "none";
        }
    }

    function renderDashboard() {
        const searchQuery = document.getElementById('filter-search').value.toLowerCase();
        const filterType = document.getElementById('filter-type').value;
        const feed = document.getElementById('dashboard-feed');
        
        let html = '';
        let visibleCount = 0;

        STUDENTS.forEach(s => {
            if (!s.name.toLowerCase().includes(searchQuery)) return;

            const studentString = `${s.name} (${s.id})`;
            const studentReports = REPORTS.filter(r => r.primary.includes(studentString) || r.related.includes(studentString));
            
            const isMyStudent = MY_STUDENTS.some(my => my.name === s.name);
            if (USER_ROLE !== 'admin' && !isMyStudent && studentReports.length === 0) return;

            if (filterType === 'any_report' && studentReports.length === 0) return;
            if (filterType !== 'all' && filterType !== 'any_report') {
                const hasSpecificReport = studentReports.some(r => r.type === filterType);
                if (!hasSpecificReport) return; 
            }

            visibleCount++;

            const counts = {};
            studentReports.forEach(r => counts[r.type] = (counts[r.type] || 0) + 1);
            let badges = '';
            if (Object.keys(counts).length === 0) {
                badges = `<span class="bg-slate-100 text-slate-500 text-xs font-semibold px-3 py-1 rounded-full border border-slate-200">0 Incidents</span>`;
            } else {
                for (const [type, count] of Object.entries(counts)) {
                    badges += `<span class="bg-red-100 border border-red-200 text-red-800 text-xs font-bold px-3 py-1 rounded-full mr-2 shadow-sm">${type}: ${count}</span>`;
                }
            }

            let parentContactLink = s.parentEmail 
                ? `<span class="text-slate-600 text-sm font-semibold flex items-center gap-1"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg> Parent Email: <span class="select-all bg-slate-100 px-2 py-1 rounded font-mono">${s.parentEmail}</span></span>`
                : `<span class="text-slate-400 text-xs italic flex items-center gap-1">No parent email on file</span>`;

            let reportsHTML = '';
            if (studentReports.length > 0) {
                reportsHTML = `<div class="mt-4 space-y-4">`;
                studentReports.forEach(r => {
                    let statusColor = r.status === 'Pending Review' ? 'bg-yellow-100 text-yellow-800 border-yellow-300' : 'bg-green-100 text-green-800 border-green-300';
                    
                    let adminEditBlock = '';
                    if (USER_ROLE === 'admin') {
                        adminEditBlock = `
                            <div class="mt-4 bg-slate-50 p-4 rounded border border-slate-200 ml-2">
                                <strong class="block mb-2 text-slate-700 text-xs uppercase">Admin Update Portal</strong>
                                <div class="flex flex-col sm:flex-row gap-3">
                                    <select id="status-${r.id}" class="form-input text-sm sm:w-1/3">
                                        <option value="Pending Review" ${r.status === 'Pending Review' ? 'selected' : ''}>Pending Review</option>
                                        <option value="Met with Teacher" ${r.status === 'Met with Teacher' ? 'selected' : ''}>Met with Teacher</option>
                                        <option value="Met with Student" ${r.status === 'Met with Student' ? 'selected' : ''}>Met with Student</option>
                                        <option value="Student - Khalil" ${r.status === 'Student - Khalil' ? 'selected' : ''}>Student - Khalil</option>
                                        <option value="Emailed Parents" ${r.status === 'Emailed Parents' ? 'selected' : ''}>Emailed Parents</option>
                                        <option value="Met with Parents" ${r.status === 'Met with Parents' ? 'selected' : ''}>Met with Parents</option>
                                        <option value="Reviewed / Resolved" ${r.status === 'Reviewed / Resolved' ? 'selected' : ''}>Reviewed / Resolved</option>
                                        <option value="Escalated" ${r.status === 'Escalated' ? 'selected' : ''}>Escalated</option>
                                    </select>
                                    <input type="text" id="comments-${r.id}" class="form-input text-sm sm:w-2/3" placeholder="Add new note to the log...">
                                </div>
                                <div class="mt-3">
                                    <textarea id="private-notes-${r.id}" class="form-input text-sm w-full bg-yellow-50 border-yellow-200" rows="2" placeholder="ðŸ”’ Internal Admin Only Notes (Not visible to teachers)...">${r.privateNotes || ''}</textarea>
                                </div>
                                <button onclick="updateReportStatus('${r.id}')" id="btn-update-${r.id}" class="mt-3 bg-slate-800 hover:bg-slate-900 text-white text-sm font-bold py-2 px-4 rounded transition w-full sm:w-auto">
                                    Save Admin Update
                                </button>
                            </div>
                        `;
                    }

                    reportsHTML += `
                        <div class="bg-white p-5 rounded-lg border-2 border-red-500 shadow-md relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-2 h-full bg-red-600"></div>
                            
                            <div class="flex justify-between items-start mb-4 pb-4 border-b border-red-100 pl-2">
                                <div>
                                    <h5 class="text-lg font-extrabold text-red-700">${r.type}</h5>
                                    <p class="text-xs text-slate-400 mt-1">Report ID: #${r.id}</p>
                                </div>
                                <div class="flex flex-col sm:flex-row items-end sm:items-center gap-2 sm:gap-3">
                                    <span class="${statusColor} border text-xs font-bold px-3 py-1 rounded-full">${r.status}</span>
                                    
                                    <div class="flex gap-2">
                                        <button onclick="openEditablePDF('${r.id}')" class="text-slate-600 hover:text-teal-700 text-sm font-bold flex items-center gap-1 bg-slate-100 px-3 py-1 rounded transition border border-slate-200 hover:bg-teal-50 hover:border-teal-200">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg> Edit Parent PDF
                                        </button>
                                        
                                        <button onclick="downloadFormalPDF('${r.id}')" class="text-slate-600 hover:text-red-700 text-sm font-bold flex items-center gap-1 bg-slate-100 px-3 py-1 rounded transition border border-slate-200 hover:bg-red-50 hover:border-red-200">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> Internal PDF
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-y-3 gap-x-6 text-sm mb-4 pl-2">
                                <div><strong class="text-slate-500 text-xs uppercase block mb-1">Date</strong> <span class="text-slate-800 font-medium">${r.date}</span></div>
                                <div><strong class="text-slate-500 text-xs uppercase block mb-1">Location</strong> <span class="text-slate-800 font-medium">${r.location}</span></div>
                                <div><strong class="text-slate-500 text-xs uppercase block mb-1">Reported By</strong> <span class="text-slate-800 font-medium">${r.reportedBy}</span></div>
                                <div><strong class="text-slate-500 text-xs uppercase block mb-1">Witnesses/Related</strong> <span class="text-slate-800">${r.related || 'None'}</span></div>
                            </div>

                            <div class="bg-red-50/50 p-4 rounded border border-red-100 text-sm text-slate-800 mb-3 ml-2">
                                <strong class="block mb-2 text-red-800 text-xs uppercase">Description</strong>
                                <p class="leading-relaxed">${r.description}</p>
                            </div>
                            <div class="bg-red-50/50 p-4 rounded border border-red-100 text-sm text-slate-800 mb-3 ml-2">
                                <strong class="block mb-2 text-red-800 text-xs uppercase">Student's Initial Response</strong>
                                <p class="leading-relaxed">${r.studentResponse || 'N/A'}</p>
                            </div>
                            <div class="bg-red-50/50 p-4 rounded border border-red-100 text-sm text-slate-800 mb-3 ml-2">
                                <strong class="block mb-2 text-red-800 text-xs uppercase">Action Taken</strong>
                                <p class="leading-relaxed">${r.actionTaken}</p>
                            </div>
                            
                            ${r.comments ? `<div class="bg-slate-800 p-4 rounded border border-slate-700 text-sm text-white ml-2"><strong class="block mb-2 text-slate-300 text-xs uppercase">Admin Update History</strong><p class="leading-relaxed whitespace-pre-wrap">${r.comments}</p></div>` : ''}
                            
                            ${adminEditBlock}
                        </div>
                    `;
                });
                reportsHTML += `</div>`;
            } else {
                reportsHTML = `<div class="bg-white rounded border border-slate-200 p-8 text-center mt-4"><p class="text-slate-500 italic">No incident history recorded for this student.</p></div>`;
            }

            html += `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden fade-in">
                    <div class="p-5 cursor-pointer hover:bg-slate-50 transition flex justify-between items-center" onclick="toggleDetails('${s.id}')">
                        <div>
                            <h3 class="text-lg font-bold text-slate-800">${s.name} <span class="bg-slate-100 text-slate-500 text-xs px-2 py-0.5 rounded ml-2 align-middle">Grade ${s.grade}</span></h3>
                            <div class="mt-3 flex flex-wrap gap-2">${badges}</div>
                        </div>
                        <div class="text-slate-400">
                            <svg id="icon-${s.id}" class="w-6 h-6 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    
                    <div id="details-${s.id}" class="hidden bg-slate-100 p-5 border-t border-slate-200 shadow-inner">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4 bg-white p-3 rounded border border-slate-200">
                            ${parentContactLink}
                            <button onclick="fileReportForStudent('${s.id}')" class="bg-red-700 text-white text-sm font-bold px-4 py-2 rounded shadow hover:bg-red-800 transition transform active:scale-95 w-full sm:w-auto">
                                + File Report for ${s.name}
                            </button>
                        </div>
                        ${reportsHTML}
                    </div>
                </div>
            `;
        });
        
        feed.innerHTML = visibleCount > 0 ? html : `<div class="text-slate-500 text-center py-10 bg-white rounded-xl border border-slate-200 shadow-sm">No students match your selected filters.</div>`;
    }

    function toggleDetails(studentId) {
        const student = STUDENTS.find(s => String(s.id) === String(studentId));
        const studentName = student ? student.name : "Unknown Student";

        const details = document.getElementById(`details-${studentId}`);
        const icon = document.getElementById(`icon-${studentId}`);
        
        if (details.classList.contains('hidden')) {
            details.classList.remove('hidden');
            icon.classList.add('rotate-180');
            
            if (!VIEWED_STUDENTS.has(studentId)) {
                VIEWED_STUDENTS.add(studentId);
                
                if (VIEWED_STUDENTS.size > 2) {
                    document.getElementById('warning-modal').classList.remove('hidden');
                }
            }

            fetch(BACKEND_URL, {
                method: 'POST', 
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'trackView', token: USER_TOKEN, studentName: studentName })
            });

        } else {
            details.classList.add('hidden');
            icon.classList.remove('rotate-180');
        }
    }

    function fileReportForStudent(studentId) {
        switchTab('report');
        document.getElementById('submission-form').reset();
        
        document.getElementById('search-primary').value = '';
        document.getElementById('search-related').value = '';
        filterCheckboxes(document.getElementById('search-primary'), 'primary-students-list');
        filterCheckboxes(document.getElementById('search-related'), 'related-students-list');

        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        
        const targetCb = document.getElementById(`primary-cb-${studentId}`);
        if (targetCb) {
            targetCb.checked = true;
            targetCb.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        window.scrollTo(0, 0);
    }

    function getSelectedCheckboxes(containerId) {
        return Array.from(document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`)).map(cb => cb.value);
    }

    function submitReport(e) {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        const primary = getSelectedCheckboxes('primary-students-list');
        const related = getSelectedCheckboxes('related-students-list');

        if(primary.length === 0) return alert("Please select at least one primary student.");

        btn.disabled = true; btn.innerText = "Processing...";

        fetch(BACKEND_URL, {
            method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'submitReport', token: USER_TOKEN,
                incidentDate: document.getElementById('incDate').value, incidentType: document.getElementById('incType').value,
                location: document.getElementById('incLocation').value, primaryStudents: primary, relatedStudents: related,
                description: document.getElementById('incDescription').value, actionTaken: document.getElementById('incAction').value,
                studentResponse: document.getElementById('incStudentResponse').value 
            })
        }).then(() => {
            alert("Official Report submitted successfully.");
            document.getElementById('submission-form').reset();
            fetchData(); switchTab('dashboard');
            btn.disabled = false; btn.innerText = "Submit Official Report";
        });
    }

    function updateReportStatus(reportId) {
        const btn = document.getElementById(`btn-update-${reportId}`);
        const newStatus = document.getElementById(`status-${reportId}`).value;
        const comments = document.getElementById(`comments-${reportId}`).value;
        // Grab private notes (might be null if user is not admin, so optional chaining or empty string)
        const privateNotes = document.getElementById(`private-notes-${reportId}`)?.value || "";

        btn.disabled = true;
        btn.innerText = "Saving Update...";

        fetch(BACKEND_URL, {
            method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'updateReport', 
                token: USER_TOKEN,
                reportId: reportId,
                newStatus: newStatus,
                adminComments: comments,
                privateNotes: privateNotes // Send new private note
            })
        }).then(() => {
            alert("Report successfully updated.");
            fetchData(); 
        }).catch(() => {
            alert("Error saving the update. Please check your connection.");
            btn.disabled = false;
            btn.innerText = "Save Admin Update";
        });
    }

    function buildPDFHTML(r, isForParent = false) {
        return `
            <div style="width: 800px; padding: 50px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; color: #1e293b; background: #fff;">
                <div style="text-align: center; border-bottom: 3px solid #0d9488; padding-bottom: 20px; margin-bottom: 30px;">
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; color: #0f766e; letter-spacing: 1px;">Silicon Valley Academy</h1>
                    <h2 style="font-size: 16px; margin: 8px 0 0 0; color: #64748b; text-transform: uppercase; letter-spacing: 2px;">Official Incident Report</h2>
                </div>
                
                <table style="width: 100%; font-size: 14px; margin-bottom: 25px; border-collapse: collapse;">
                    <tr><td style="padding: 8px 0;"><strong>Report ID:</strong> ${r.id}</td><td style="padding: 8px 0; text-align: right;"><strong>Status:</strong> ${r.status}</td></tr>
                    <tr><td style="padding: 8px 0;"><strong>Date of Incident:</strong> ${r.date}</td><td style="padding: 8px 0; text-align: right;"><strong>Date Filed:</strong> ${new Date(r.timestamp).toLocaleDateString()}</td></tr>
                    <tr><td style="padding: 8px 0;"><strong>Incident Type:</strong> ${r.type}</td><td style="padding: 8px 0; text-align: right;"><strong>Location:</strong> ${r.location}</td></tr>
                </table>

                <div style="background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 25px; border-radius: 4px;">
                    <p style="margin: 0 0 10px 0; font-size: 14px;"><strong>Reporting Staff / Faculty:</strong> ${r.reportedBy}</p>
                    <p style="margin: 0 0 10px 0; font-size: 14px;"><strong>Primary Student(s) Involved:</strong><br> <span style="color: #475569;">${r.primary}</span></p>
                    <p style="margin: 0; font-size: 14px;"><strong>Witness / Related Student(s):</strong><br> <span style="color: #475569;">${r.related || 'None reported'}</span></p>
                </div>

                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 16px; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; color: #0f172a;">Detailed Description</h3>
                    <p style="font-size: 14px; line-height: 1.6; color: #334155; white-space: pre-wrap;">${r.description}</p>
                </div>

                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 16px; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; color: #0f172a;">Student's Initial Response</h3>
                    <p style="font-size: 14px; line-height: 1.6; color: #334155; white-space: pre-wrap;">${r.studentResponse || 'N/A'}</p>
                </div>

                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 16px; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; color: #0f172a;">Immediate Action Taken</h3>
                    <p style="font-size: 14px; line-height: 1.6; color: #334155; white-space: pre-wrap;">${r.actionTaken}</p>
                </div>

                ${(!isForParent && r.comments) ? `<div style="margin-bottom: 25px;"><h3 style="font-size: 16px; border-bottom: 2px solid #0d9488; padding-bottom: 5px; color: #0f766e;">Administrative Review Notes</h3><p style="font-size: 14px; line-height: 1.6; color: #334155; white-space: pre-wrap;">${r.comments}</p></div>` : ''}

                <div style="margin-top: 80px; display: flex; justify-content: space-between;">
                    <div style="width: 40%; border-top: 1px solid #000; text-align: center; padding-top: 8px; font-size: 14px; font-weight: 600;">
                        Staff Signature<br>
                        <div style="font-family: 'Brush Script MT', cursive; font-size: 24px; color: #1e293b; margin-top: 5px;">${r.reportedBy}</div>
                    </div>
                    <div style="width: 40%; border-top: 1px solid #000; text-align: center; padding-top: 8px; font-size: 14px; font-weight: 600;">
                        Administrator Signature<br>
                        <div style="font-family: 'Brush Script MT', cursive; font-size: 24px; color: #1e293b; margin-top: 5px;">Mona Nezzar</div>
                    </div>
                </div>
                
                <div style="margin-top: 40px; text-align: center; font-size: 10px; color: #94a3b8;">
                    CONFIDENTIAL - SVA School Records - Generated on ${new Date().toLocaleString()}
                </div>
            </div>
        `;
    }

    function downloadFormalPDF(reportId) {
        const r = REPORTS.find(rep => rep.id === reportId);
        if (!r) return;

        const printDiv = document.createElement('div');
        printDiv.style.position = 'absolute'; 
        printDiv.style.left = '-9999px'; 
        printDiv.style.top = '0';
        printDiv.innerHTML = buildPDFHTML(r, false);
        document.body.appendChild(printDiv);

        const opt = {
            margin: 0, filename: `SVA_Internal_${reportId}.pdf`, image: { type: 'jpeg', quality: 1 },
            html2canvas: { scale: 2, useCORS: true, scrollY: 0, windowY: 0 }, 
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(printDiv.children[0]).save().then(() => { document.body.removeChild(printDiv); });
    }

    let CURRENT_EDIT_REPORT_ID = null;
    function openEditablePDF(reportId) {
        const r = REPORTS.find(rep => rep.id === reportId);
        if (!r) return;
        CURRENT_EDIT_REPORT_ID = reportId;
        document.getElementById('editable-pdf-content').innerHTML = buildPDFHTML(r, true);
        document.getElementById('pdf-edit-modal').classList.remove('hidden');
    }

    function closeEditablePDF() {
        document.getElementById('pdf-edit-modal').classList.add('hidden');
        CURRENT_EDIT_REPORT_ID = null;
    }

    function saveEditedPDF() {
    const original = document.getElementById('editable-pdf-content');

    const clone = original.cloneNode(true);
    clone.style.width = "8.5in";
    clone.style.padding = "0.5in";
    clone.style.background = "#fff";

    clone.style.position = "absolute";
    clone.style.left = "-9999px";
    clone.style.top = "0";

    document.body.appendChild(clone);

    const opt = {
        margin: 0,
        filename: `SVA_ParentReport_${CURRENT_EDIT_REPORT_ID}.pdf`,
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(clone).save().then(() => {
        document.body.removeChild(clone);
        closeEditablePDF();
    });
}
</script>
</body>
</html>
