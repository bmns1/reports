<script>
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxJgMn6ad4FbQsK31Ue5TQhG3f-kcL16yX_FeHz-N-sE1cLrro8O92TfNsNQJ4VwfL6Xw/exec"; 
    let USER_TOKEN = "", USER_EMAIL = "", USER_ROLE = "";
    let STUDENTS = [], MY_STUDENTS = [], REPORTS = [];

    function handleCredentialResponse(response) {
        USER_TOKEN = response.credential; 
        USER_EMAIL = JSON.parse(atob(response.credential.split('.')[1])).email;
        document.getElementById('view-login').classList.add('hidden');
        document.getElementById('view-app').classList.remove('hidden');
        document.getElementById('user-display').innerText = USER_EMAIL;
        fetchData();
    }

    function logout() {
        USER_TOKEN = ""; USER_EMAIL = "";
        document.getElementById('view-app').classList.add('hidden');
        document.getElementById('view-login').classList.remove('hidden');
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-btn-${tabName}`).classList.add('active');
        document.getElementById('tab-dashboard').classList.add('hidden');
        document.getElementById('tab-report').classList.add('hidden');
        document.getElementById(`tab-${tabName}`).classList.remove('hidden');
    }

    function fetchData() {
        fetch(BACKEND_URL, {
            method: 'POST', body: JSON.stringify({ action: 'init', token: USER_TOKEN })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                USER_ROLE = data.role; 
                STUDENTS = data.students; 
                MY_STUDENTS = data.myStudents || []; // Maps the teacher's specific roster
                REPORTS = data.reports;
                
                document.getElementById('role-display').innerText = USER_ROLE;
                populateStudents(); 
                renderDashboard();
            } else { alert(data.message); logout(); }
        });
    }

    function populateStudents() {
        let primaryHTML = '';
        let relatedHTML = '';
        // Populates the "File Report" form with EVERY student in the school
        STUDENTS.forEach(s => {
            primaryHTML += `<label class="flex items-center space-x-2 py-1"><input type="checkbox" id="primary-cb-${s.id}" value="${s.name} (${s.id})" class="form-checkbox text-red-600 rounded focus:ring-red-500"><span>${s.name} <span class="text-slate-400 ml-1 text-xs">Gr.${s.grade}</span></span></label>`;
            relatedHTML += `<label class="flex items-center space-x-2 py-1"><input type="checkbox" id="related-cb-${s.id}" value="${s.name} (${s.id})" class="form-checkbox text-red-600 rounded focus:ring-red-500"><span>${s.name} <span class="text-slate-400 ml-1 text-xs">Gr.${s.grade}</span></span></label>`;
        });
        document.getElementById('primary-students-list').innerHTML = primaryHTML || "No assigned students found.";
        document.getElementById('related-students-list').innerHTML = relatedHTML || "No assigned students found.";
    }

    function filterCheckboxes(inputElement, listId) {
        const filter = inputElement.value.toLowerCase();
        const labels = document.getElementById(listId).getElementsByTagName('label');
        for (let i = 0; i < labels.length; i++) {
            const text = labels[i].innerText.toLowerCase();
            labels[i].style.display = text.includes(filter) ? "flex" : "none";
        }
    }

    function renderDashboard() {
        const searchQuery = document.getElementById('filter-search').value.toLowerCase();
        const filterType = document.getElementById('filter-type').value;
        const feed = document.getElementById('dashboard-feed');
        
        let html = '';
        let visibleCount = 0;

        STUDENTS.forEach(s => {
            // Apply Text Search
            if (!s.name.toLowerCase().includes(searchQuery)) return;

            const studentString = `${s.name} (${s.id})`;
            const studentReports = REPORTS.filter(r => r.primary.includes(studentString) || r.related.includes(studentString));
            
            // ==========================================
            // UI VISIBILITY FILTER
            // ==========================================
            // Admins see everyone. 
            // Teachers see their own students OR students they authored a report for.
            const isMyStudent = MY_STUDENTS.some(my => my.name === s.name);
            if (USER_ROLE !== 'admin' && !isMyStudent && studentReports.length === 0) return;

            // Apply Dropdown Filter
            if (filterType === 'any_report' && studentReports.length === 0) return;
            if (filterType !== 'all' && filterType !== 'any_report') {
                const hasSpecificReport = studentReports.some(r => r.type === filterType);
                if (!hasSpecificReport) return; 
            }

            visibleCount++;

            // Incident Badges
            const counts = {};
            studentReports.forEach(r => counts[r.type] = (counts[r.type] || 0) + 1);
            let badges = '';
            if (Object.keys(counts).length === 0) {
                badges = `<span class="bg-slate-100 text-slate-500 text-xs font-semibold px-3 py-1 rounded-full border border-slate-200">0 Incidents</span>`;
            } else {
                for (const [type, count] of Object.entries(counts)) {
                    badges += `<span class="bg-red-100 border border-red-200 text-red-800 text-xs font-bold px-3 py-1 rounded-full mr-2 shadow-sm">${type}: ${count}</span>`;
                }
            }

            // Parent Email Logic
            let parentContactLink = s.parentEmail 
                ? `<a href="mailto:${s.parentEmail}?subject=SVA School Update regarding ${s.name}" class="text-slate-600 hover:text-teal-700 text-sm font-semibold flex items-center gap-1 transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg> Email Parent</a>`
                : `<span class="text-slate-400 text-xs italic flex items-center gap-1">No parent email on file</span>`;

            // Report Cards 
            let reportsHTML = '';
            if (studentReports.length > 0) {
                reportsHTML = `<div class="mt-4 space-y-4">`;
                studentReports.forEach(r => {
                    let statusColor = r.status === 'Pending Review' ? 'bg-yellow-100 text-yellow-800 border-yellow-300' : 'bg-green-100 text-green-800 border-green-300';
                    
                    reportsHTML += `
                        <div class="bg-white p-5 rounded-lg border-2 border-red-500 shadow-md relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-2 h-full bg-red-600"></div>
                            
                            <div class="flex justify-between items-start mb-4 pb-4 border-b border-red-100 pl-2">
                                <div>
                                    <h5 class="text-lg font-extrabold text-red-700">${r.type}</h5>
                                    <p class="text-xs text-slate-400 mt-1">Report ID: #${r.id}</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="${statusColor} border text-xs font-bold px-3 py-1 rounded-full">${r.status}</span>
                                    <button onclick="downloadFormalPDF('${r.id}')" class="text-slate-600 hover:text-red-700 text-sm font-bold flex items-center gap-1 bg-slate-100 px-3 py-1 rounded transition border border-slate-200 hover:bg-red-50 hover:border-red-200"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> Save PDF</button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-y-3 gap-x-6 text-sm mb-4 pl-2">
                                <div><strong class="text-slate-500 text-xs uppercase block mb-1">Date</strong> <span class="text-slate-800 font-medium">${r.date}</span></div>
                                <div><strong class="text-slate-500 text-xs uppercase block mb-1">Location</strong> <span class="text-slate-800 font-medium">${r.location}</span></div>
                                <div><strong class="text-slate-500 text-xs uppercase block mb-1">Reported By</strong> <span class="text-slate-800 font-medium">${r.reportedBy}</span></div>
                                <div><strong class="text-slate-500 text-xs uppercase block mb-1">Witnesses/Related</strong> <span class="text-slate-800">${r.related || 'None'}</span></div>
                            </div>

                            <div class="bg-red-50/50 p-4 rounded border border-red-100 text-sm text-slate-800 mb-3 ml-2">
                                <strong class="block mb-2 text-red-800 text-xs uppercase">Description</strong>
                                <p class="leading-relaxed">${r.description}</p>
                            </div>
                            <div class="bg-red-50/50 p-4 rounded border border-red-100 text-sm text-slate-800 mb-3 ml-2">
                                <strong class="block mb-2 text-red-800 text-xs uppercase">Action Taken</strong>
                                <p class="leading-relaxed">${r.actionTaken}</p>
                            </div>
                            
                            ${r.comments ? `<div class="bg-slate-800 p-4 rounded border border-slate-700 text-sm text-white ml-2"><strong class="block mb-2 text-slate-300 text-xs uppercase">Administrator Note</strong><p class="leading-relaxed">${r.comments}</p></div>` : ''}
                        </div>
                    `;
                });
                reportsHTML += `</div>`;
            } else {
                reportsHTML = `<div class="bg-white rounded border border-slate-200 p-8 text-center mt-4"><p class="text-slate-500 italic">No incident history recorded for this student.</p></div>`;
            }

            // Student Row
            html += `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden fade-in">
                    <div class="p-5 cursor-pointer hover:bg-slate-50 transition flex justify-between items-center" onclick="toggleDetails('${s.id}')">
                        <div>
                            <h3 class="text-lg font-bold text-slate-800">${s.name} <span class="bg-slate-100 text-slate-500 text-xs px-2 py-0.5 rounded ml-2 align-middle">Grade ${s.grade}</span></h3>
                            <div class="mt-3 flex flex-wrap gap-2">${badges}</div>
                        </div>
                        <div class="text-slate-400">
                            <svg id="icon-${s.id}" class="w-6 h-6 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    
                    <div id="details-${s.id}" class="hidden bg-slate-100 p-5 border-t border-slate-200 shadow-inner">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4 bg-white p-3 rounded border border-slate-200">
                            ${parentContactLink}
                            <button onclick="fileReportForStudent('${s.id}')" class="bg-red-700 text-white text-sm font-bold px-4 py-2 rounded shadow hover:bg-red-800 transition transform active:scale-95 w-full sm:w-auto">
                                + File Report for ${s.name}
                            </button>
                        </div>
                        ${reportsHTML}
                    </div>
                </div>
            `;
        });
        
        feed.innerHTML = visibleCount > 0 ? html : `<div class="text-slate-500 text-center py-10 bg-white rounded-xl border border-slate-200 shadow-sm">No students match your selected filters.</div>`;
    }

    function toggleDetails(studentId) {
        const details = document.getElementById(`details-${studentId}`);
        const icon = document.getElementById(`icon-${studentId}`);
        if (details.classList.contains('hidden')) {
            details.classList.remove('hidden');
            icon.classList.add('rotate-180');
        } else {
            details.classList.add('hidden');
            icon.classList.remove('rotate-180');
        }
    }

    function fileReportForStudent(studentId) {
        switchTab('report');
        document.getElementById('submission-form').reset();
        
        document.getElementById('search-primary').value = '';
        document.getElementById('search-related').value = '';
        filterCheckboxes(document.getElementById('search-primary'), 'primary-students-list');
        filterCheckboxes(document.getElementById('search-related'), 'related-students-list');

        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        
        const targetCb = document.getElementById(`primary-cb-${studentId}`);
        if (targetCb) {
            targetCb.checked = true;
            targetCb.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        window.scrollTo(0, 0);
    }

    function getSelectedCheckboxes(containerId) {
        return Array.from(document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`)).map(cb => cb.value);
    }

    function submitReport(e) {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        const primary = getSelectedCheckboxes('primary-students-list');
        const related = getSelectedCheckboxes('related-students-list');

        if(primary.length === 0) return alert("Please select at least one primary student.");

        btn.disabled = true; btn.innerText = "Processing...";

        fetch(BACKEND_URL, {
            method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'submitReport', token: USER_TOKEN,
                incidentDate: document.getElementById('incDate').value, incidentType: document.getElementById('incType').value,
                location: document.getElementById('incLocation').value, primaryStudents: primary, relatedStudents: related,
                description: document.getElementById('incDescription').value, actionTaken: document.getElementById('incAction').value
            })
        }).then(() => {
            alert("Official Report submitted successfully.");
            document.getElementById('submission-form').reset();
            fetchData(); switchTab('dashboard');
            btn.disabled = false; btn.innerText = "Submit Official Report";
        });
    }

    // Official PDF Generator
    function downloadFormalPDF(reportId) {
        const r = REPORTS.find(rep => rep.id === reportId);
        if (!r) return;

        const printDiv = document.createElement('div');
        printDiv.style.position = 'absolute'; 
        printDiv.style.left = '-9999px'; 
        printDiv.style.top = '0';
        
        printDiv.innerHTML = `
            <div style="width: 800px; padding: 50px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; color: #1e293b; background: #fff;">
                <div style="text-align: center; border-bottom: 3px solid #0d9488; padding-bottom: 20px; margin-bottom: 30px;">
                    <h1 style="font-size: 28px; font-weight: 800; margin: 0; color: #0f766e; letter-spacing: 1px;">Silicon Valley Academy</h1>
                    <h2 style="font-size: 16px; margin: 8px 0 0 0; color: #64748b; text-transform: uppercase; letter-spacing: 2px;">Official Incident Report</h2>
                </div>
                
                <table style="width: 100%; font-size: 14px; margin-bottom: 25px; border-collapse: collapse;">
                    <tr><td style="padding: 8px 0;"><strong>Report ID:</strong> ${r.id}</td><td style="padding: 8px 0; text-align: right;"><strong>Status:</strong> ${r.status}</td></tr>
                    <tr><td style="padding: 8px 0;"><strong>Date of Incident:</strong> ${r.date}</td><td style="padding: 8px 0; text-align: right;"><strong>Date Filed:</strong> ${new Date(r.timestamp).toLocaleDateString()}</td></tr>
                    <tr><td style="padding: 8px 0;"><strong>Incident Type:</strong> ${r.type}</td><td style="padding: 8px 0; text-align: right;"><strong>Location:</strong> ${r.location}</td></tr>
                </table>

                <div style="background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 25px; border-radius: 4px;">
                    <p style="margin: 0 0 10px 0; font-size: 14px;"><strong>Reporting Staff / Faculty:</strong> ${r.reportedBy}</p>
                    <p style="margin: 0 0 10px 0; font-size: 14px;"><strong>Primary Student(s) Involved:</strong><br> <span style="color: #475569;">${r.primary}</span></p>
                    <p style="margin: 0; font-size: 14px;"><strong>Witness / Related Student(s):</strong><br> <span style="color: #475569;">${r.related || 'None reported'}</span></p>
                </div>

                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 16px; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; color: #0f172a;">Detailed Description</h3>
                    <p style="font-size: 14px; line-height: 1.6; color: #334155; white-space: pre-wrap;">${r.description}</p>
                </div>

                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 16px; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; color: #0f172a;">Immediate Action Taken</h3>
                    <p style="font-size: 14px; line-height: 1.6; color: #334155; white-space: pre-wrap;">${r.actionTaken}</p>
                </div>

                ${r.comments ? `<div style="margin-bottom: 25px;"><h3 style="font-size: 16px; border-bottom: 2px solid #0d9488; padding-bottom: 5px; color: #0f766e;">Administrative Review Notes</h3><p style="font-size: 14px; line-height: 1.6; color: #334155; white-space: pre-wrap;">${r.comments}</p></div>` : ''}

                <div style="margin-top: 80px; display: flex; justify-content: space-between;">
                    <div style="width: 40%; border-top: 1px solid #000; text-align: center; padding-top: 8px; font-size: 14px; font-weight: 600;">Staff Signature</div>
                    <div style="width: 40%; border-top: 1px solid #000; text-align: center; padding-top: 8px; font-size: 14px; font-weight: 600;">Administrator Signature</div>
                </div>
                
                <div style="margin-top: 40px; text-align: center; font-size: 10px; color: #94a3b8;">
                    CONFIDENTIAL - SVA School Internal Records - Generated on ${new Date().toLocaleString()}
                </div>
            </div>
        `;
        
        document.body.appendChild(printDiv);

        const opt = {
            margin: 0, 
            filename: `SVA_Incident_${reportId}.pdf`, 
            image: { type: 'jpeg', quality: 1 },
            html2canvas: { 
                scale: 2, 
                useCORS: true,
                scrollY: 0, 
                windowY: 0  
            }, 
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(printDiv.children[0]).save().then(() => { 
            document.body.removeChild(printDiv); 
        });
    }
</script>
